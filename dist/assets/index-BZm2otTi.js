(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();class P{constructor(t,e){this.canvas=t,this.spectrogramCanvas=e,this.ctx=t.getContext("2d"),this.spectrogramCtx=e.getContext("2d"),this.audioCtx=null,this.analyser=null,this.source=null,this.isPlaying=!1,this.spectrogramData=[],this.maxSpectrogramLength=200,this.fftSize=2048,this.audioDuration=0,this.audioElement=null,this.dataArray=null,this.freqData=null,console.log("Initializing AudioProcessor with spectrogram:",{canvas:!!t,spectrogramCanvas:!!e}),this.canvas.width=this.canvas.offsetWidth,this.canvas.height=150,this.spectrogramCanvas.width=this.spectrogramCanvas.offsetWidth,this.spectrogramCanvas.height=150,window.addEventListener("resize",()=>{this.canvas.width=this.canvas.offsetWidth,this.spectrogramCanvas.width=this.spectrogramCanvas.offsetWidth,this.updateVisualizer()}),this.spectrogramGradient=this.createSpectrogramGradient(),this.analyzedUnits=[],this.unitThreshold=-70,this.minUnitDuration=.2,this.maxUnitDuration=2}createSpectrogramGradient(){const t=document.createElement("canvas");t.width=1,t.height=256;const e=t.getContext("2d"),i=e.createLinearGradient(0,0,0,256);return i.addColorStop(0,"#000060"),i.addColorStop(.5,"#00ff00"),i.addColorStop(.75,"#ffff00"),i.addColorStop(1,"#ff0000"),e.fillStyle=i,e.fillRect(0,0,1,256),e.getImageData(0,0,1,256).data}initialize(t){if(console.log("Initializing audio context and analyser"),this.audioElement=t,this.audioDuration=t.duration,this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext)),this.analyser||(this.analyser=this.audioCtx.createAnalyser(),this.analyser.fftSize=this.fftSize,this.analyser.minDecibels=-90,this.analyser.maxDecibels=-30,this.analyser.smoothingTimeConstant=.85,this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.freqData=new Uint8Array(this.analyser.frequencyBinCount)),!this.source||this.source.mediaElement!==t){if(this.source)try{this.source.disconnect()}catch{console.log("No need to disconnect source")}try{this.source=this.audioCtx.createMediaElementSource(t),this.source.connect(this.analyser),this.analyser.connect(this.audioCtx.destination)}catch(e){if(console.log("Error connecting audio source:",e),e.name!=="InvalidStateError")throw e}}}updateVisualizer(){if(!this.isPlaying)return;requestAnimationFrame(()=>this.updateVisualizer()),(!this.dataArray||!this.freqData)&&(this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.freqData=new Uint8Array(this.analyser.frequencyBinCount)),this.analyser.getByteFrequencyData(this.dataArray),this.updateSpectrogram(),this.ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--primary-color"),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const t=this.canvas.width/this.dataArray.length*2.5;let e=0,i=0,s=0;for(let a=0;a<this.dataArray.length;a++){const n=this.dataArray[a];s+=n,n>this.dataArray[i]&&(i=a);const o=this.ctx.createLinearGradient(0,0,0,this.canvas.height);o.addColorStop(0,"#4a90e2"),o.addColorStop(1,"#1a3a4a"),this.ctx.fillStyle=o,this.ctx.fillRect(e,this.canvas.height-n/2,t,n/2),e+=t+1}return{peakFrequency:i*(this.audioCtx.sampleRate/2)/this.dataArray.length,averageVolume:s/this.dataArray.length}}updateSpectrogram(){if(!this.isPlaying||!this.freqData)return;this.analyser.getByteFrequencyData(this.freqData);const t=this.spectrogramCtx.getImageData(0,0,this.spectrogramCanvas.width,this.spectrogramCanvas.height);this.spectrogramCtx.clearRect(0,0,this.spectrogramCanvas.width,this.spectrogramCanvas.height),this.spectrogramCtx.putImageData(t,1,0);const e=this.spectrogramCanvas.height/this.analyser.frequencyBinCount,i=this.spectrogramCtx.createImageData(1,this.spectrogramCanvas.height);for(let s=0;s<this.freqData.length;s++){const a=this.freqData[s],n=Math.floor(s*e),o=Math.floor(a/255*255),d=this.spectrogramGradient[o*4],h=this.spectrogramGradient[o*4+1],g=this.spectrogramGradient[o*4+2];for(let l=0;l<e&&n+l<this.spectrogramCanvas.height;l++){const m=(n+l)*4;i.data[m]=d,i.data[m+1]=h,i.data[m+2]=g,i.data[m+3]=255}}this.spectrogramCtx.putImageData(i,0,0),this.drawTimeMarker(),this.drawUnitMarkers()}drawTimeMarker(){if(!this.audioElement||!this.isPlaying)return;const e=this.audioElement.currentTime/this.audioDuration*this.spectrogramCanvas.width;this.spectrogramCtx.strokeStyle="rgba(255, 255, 255, 0.5)",this.spectrogramCtx.lineWidth=1,this.spectrogramCtx.beginPath(),this.spectrogramCtx.moveTo(e,0),this.spectrogramCtx.lineTo(e,this.spectrogramCanvas.height),this.spectrogramCtx.stroke()}drawUnitMarkers(){!this.analyzedUnits||!this.analyzedUnits.length||this.analyzedUnits.forEach((t,e)=>{const i=t.startTime/this.audioDuration*this.spectrogramCanvas.width,s=t.endTime/this.audioDuration*this.spectrogramCanvas.width;this.spectrogramCtx.fillStyle="rgba(0, 255, 0, 0.05)",this.spectrogramCtx.fillRect(i,0,s-i,this.spectrogramCanvas.height),this.spectrogramCtx.strokeStyle="rgba(0, 255, 0, 0.3)",this.spectrogramCtx.lineWidth=1,this.spectrogramCtx.beginPath(),this.spectrogramCtx.moveTo(i,0),this.spectrogramCtx.lineTo(i,this.spectrogramCanvas.height),this.spectrogramCtx.moveTo(s,0),this.spectrogramCtx.lineTo(s,this.spectrogramCanvas.height),this.spectrogramCtx.stroke()})}detectUnits(){const t=[];let e={start:0,end:0,data:[]},i=20;for(let s=0;s<this.spectrogramData.length;s++)this.spectrogramData[s].reduce((n,o)=>n+o,0)/this.spectrogramData[s].length>i?(e.start===0&&(e.start=s),e.data.push(this.spectrogramData[s])):e.start!==0&&(e.end=s,t.push(e),e={start:0,end:0,data:[]});return t}start(){this.isPlaying=!0,this.updateVisualizer()}stop(){this.isPlaying=!1}getAudioData(){if(!this.analyser||!this.dataArray)return null;this.analyser.getByteFrequencyData(this.dataArray);let t=0,e=0;for(let i=0;i<this.dataArray.length;i++)t+=this.dataArray[i],this.dataArray[i]>this.dataArray[e]&&(e=i);return{peakFrequency:e*(this.audioCtx.sampleRate/2)/this.dataArray.length,averageVolume:t/this.dataArray.length,units:this.detectUnits()}}async analyzeAudioFile(t){console.log("Analyzing audio file...");try{const e=await t.arrayBuffer(),i=new(window.AudioContext||window.webkitAudioContext),s=await i.decodeAudioData(e),a=i.createAnalyser();a.fftSize=this.fftSize,a.minDecibels=-90,a.maxDecibels=-30,a.smoothingTimeConstant=.8;const n=a.frequencyBinCount,o=this.fftSize,d=Math.ceil(s.length/o);console.log("Analysis parameters:",{fftSize:this.fftSize,bufferLength:n,totalSlices:d,duration:s.duration,sampleRate:s.sampleRate,channels:s.numberOfChannels,totalSamples:s.length});const h=s.getChannelData(0),g=new Float32Array(d*n);console.log("Starting slice processing...");const l=document.createElement("canvas");l.width=d,l.height=n;const m=l.getContext("2d");for(let u=0;u<d;u++){const y=u*o,S=Math.min(y+o,h.length)-y;let C=0;for(let r=0;r<S;r++)C=Math.max(C,Math.abs(h[y+r]));if(C<.01){for(let r=0;r<this.fftSize/2;r++)g[u*n+r]=-90;continue}const v=new OfflineAudioContext(1,this.fftSize,s.sampleRate),c=v.createAnalyser();c.fftSize=this.fftSize,c.minDecibels=-90,c.maxDecibels=-30,c.smoothingTimeConstant=0;const x=v.createBuffer(1,this.fftSize,s.sampleRate),f=x.getChannelData(0);for(let r=0;r<this.fftSize;r++)if(r<S){const L=.5*(1-Math.cos(2*Math.PI*r/S));f[r]=h[y+r]*L}else f[r]=0;const w=v.createBufferSource();w.buffer=x,w.connect(c),c.connect(v.destination);const F=new Promise((r,L)=>{v.oncomplete=A=>r(A.renderedBuffer),v.onerror=L});w.start(0),await v.startRendering(),await F;const p=new Float32Array(c.frequencyBinCount);c.getFloatFrequencyData(p);for(let r=0;r<c.frequencyBinCount;r++)g[u*n+r]=p[r];const b=m.createImageData(1,n);for(let r=0;r<n;r++){const A=(p[r]-c.minDecibels)/(c.maxDecibels-c.minDecibels),z=Math.max(0,Math.min(1,A)),D=Math.floor(z*255),B=this.spectrogramGradient[D*4],M=this.spectrogramGradient[D*4+1],k=this.spectrogramGradient[D*4+2],E=(n-1-r)*4;b.data[E]=B,b.data[E+1]=M,b.data[E+2]=k,b.data[E+3]=255}m.putImageData(b,u,0),u%100===0&&console.log(`Processing slice ${u}/${d}`,{timeOffset:u*o/s.sampleRate,maxAmplitude:C,sampleFreqData:p.slice(0,5),minValue:Math.min(...p),maxValue:Math.max(...p),avgValue:p.reduce((r,L)=>r+L,0)/p.length})}return console.log("Finished processing all slices"),this.fullSpectrogramData=g,this.fullSpectrogramImage=l,this.analyzedUnits=this.detectUnitsFromSpectrogram(g,s.sampleRate,o),console.log("Analysis complete:",{unitsFound:this.analyzedUnits.length,totalSlices:d,spectrogramWidth:l.width,spectrogramHeight:l.height}),this.renderFullSpectrogram(),{units:this.analyzedUnits,duration:s.duration,sampleRate:s.sampleRate}}catch(e){throw console.error("Error analyzing audio file:",e),e}}renderFullSpectrogram(){this.spectrogramCtx.clearRect(0,0,this.spectrogramCanvas.width,this.spectrogramCanvas.height),this.spectrogramCtx.drawImage(this.fullSpectrogramImage,0,0,this.fullSpectrogramImage.width,this.fullSpectrogramImage.height,0,0,this.spectrogramCanvas.width,this.spectrogramCanvas.height),this.analyzedUnits&&this.drawUnitMarkers(),this.isPlaying&&this.audioElement&&this.drawTimeMarker()}updateSpectrogram(){this.fullSpectrogramImage&&this.renderFullSpectrogram()}drawTimeMarker(){if(!this.audioElement)return;const e=this.audioElement.currentTime/this.audioDuration*this.spectrogramCanvas.width;this.spectrogramCtx.strokeStyle="rgba(255, 255, 255, 0.8)",this.spectrogramCtx.lineWidth=2,this.spectrogramCtx.beginPath(),this.spectrogramCtx.moveTo(e,0),this.spectrogramCtx.lineTo(e,this.spectrogramCanvas.height),this.spectrogramCtx.stroke()}drawUnitMarkers(){this.analyzedUnits&&this.analyzedUnits.forEach((t,e)=>{const i=t.startTime/this.audioDuration*this.spectrogramCanvas.width,s=t.endTime/this.audioDuration*this.spectrogramCanvas.width;this.spectrogramCtx.fillStyle="rgba(0, 255, 0, 0.1)",this.spectrogramCtx.fillRect(i,0,s-i,this.spectrogramCanvas.height),this.spectrogramCtx.strokeStyle="rgba(0, 255, 0, 0.5)",this.spectrogramCtx.lineWidth=1,this.spectrogramCtx.beginPath(),this.spectrogramCtx.moveTo(i,0),this.spectrogramCtx.lineTo(i,this.spectrogramCanvas.height),this.spectrogramCtx.moveTo(s,0),this.spectrogramCtx.lineTo(s,this.spectrogramCanvas.height),this.spectrogramCtx.stroke()})}detectUnitsFromSpectrogram(t,e,i){const s=[];let a=null;const n=this.fftSize/2,o=Math.floor(50*this.fftSize/e),d=Math.floor(4e3*this.fftSize/e),h=-70;this.minUnitDuration=.1,console.log("Unit detection parameters:",{minBin:o,maxBin:d,sampleRate:e,samplesPerSlice:i,totalSlices:t.length/n,baseThreshold:h,minDuration:this.minUnitDuration});let g=0,l=[],m=0;for(let c=0;c<t.length/n;c++){const x=c*n,f=t.slice(x+o,x+d),w=f.reduce((F,p)=>F+p,0)/f.length;g+=w,l.push(w),m++}const u=g/m,y=l.reduce((c,x)=>{const f=x-u;return c+f*f},0)/m,I=Math.sqrt(y);console.log("Signal statistics:",{averageIntensity:u,stdDev:I,maxIntensity:Math.max(...l),minIntensity:Math.min(...l)});const S=Math.max(h,u+2*I);console.log("Using adaptive threshold:",S);let C=0;const v=Math.ceil(this.minUnitDuration*e/i);for(let c=0;c<t.length/n;c++){const x=c*n,f=c*(i/e),w=t.slice(x+o,x+d),F=w.reduce((p,b)=>p+b,0)/w.length;if(c%100===0&&console.log(`Frame ${c}:`,{avgIntensity:F,threshold:S,timestamp:f,consecutiveFrames:C,minConsecutiveFrames:v}),F>S){C++,a||(console.log(`Potential unit start at ${f}s with intensity ${F}dB`),a={startTime:f,endTime:f,peakFrequencies:[],avgIntensity:[],spectrogramSlices:[]}),a.endTime=f;const p=t.slice(x,x+n);a.spectrogramSlices.push(Array.from(p));let b=0,r=w[0];for(let A=1;A<w.length;A++)w[A]>r&&(r=w[A],b=A);const L=50+b*e/this.fftSize;a.peakFrequencies.push(L),a.avgIntensity.push(F)}else{if(a&&C>=v){const p=a.endTime-a.startTime;a.dominantFrequency=this.calculateDominantFrequency(a.peakFrequencies),a.averageIntensity=a.avgIntensity.reduce((b,r)=>b+r)/a.avgIntensity.length,a.duration=p,console.log("Found unit:",{startTime:a.startTime,endTime:a.endTime,duration:p,dominantFreq:a.dominantFrequency,avgIntensity:a.averageIntensity,consecutiveFrames:C}),s.push(a)}a=null,C=0}}if(a&&C>=v){const c=a.endTime-a.startTime;a.dominantFrequency=this.calculateDominantFrequency(a.peakFrequencies),a.averageIntensity=a.avgIntensity.reduce((x,f)=>x+f)/a.avgIntensity.length,a.duration=c,s.push(a)}return s}findPeakFrequency(t,e){let i=0,s=t[0];for(let n=1;n<t.length;n++)t[n]>s&&(s=t[n],i=n);const a=e/(this.fftSize*2);return 100+i*a}calculateDominantFrequency(t){const e=new Map;let i=0,s=t[0];return t.forEach(a=>{const n=Math.round(a/10)*10,o=(e.get(n)||0)+1;e.set(n,o),o>i&&(i=o,s=n)}),s}}const q=["Narael","Vorrin","Selkai","Drumeth","Olaan","Caelo","Taruin","Fenja","Erelas"],U={names:q},$=["Raeth's Deep","The Shattered Reef","Olaan's Cry","Caelo's Rise","Narael's Fall","The Black Shoal","Driftwater","Ghost Trench"],O={locations:$},R=["his fluke low","her call fading","at dawn","when the current turned","as silence fell","beneath the storm","in mourning"],V={actions:R};class H{constructor(){this.names=U.names,this.locations=O.locations,this.actions=V.actions}pick(t){return t[Math.floor(Math.random()*t.length)]}getToneTag(t){return t>600?"high voice":t<200?"deep echo":"steady tone"}getMoodTag(t){return t>100?"with grief":t<30?"with peace":"with memory"}getAnalystAction(t,e){const i=["pattern detected","sequence complete","signal analyzed","data processed","transmission received"];return this.pick(i)}generatePhrase(t,e,i,s="emotionalist"){const a=this.pick(this.names),n=this.pick(this.locations),o=this.getToneTag(t),d=this.getMoodTag(e);let h;return s==="analyst"?h=this.getAnalystAction(t,e):h=this.pick(this.actions),`${a}, at ${n}, ${h} (${o}, ${d}) [${Math.round(i)}s]`}}class N{constructor(t){this.logList=t,this.phrases=JSON.parse(localStorage.getItem("bealePhrases")||"[]"),this.renderLog()}addPhrase(t){this.phrases.push({text:t,timestamp:new Date().toISOString()}),this.saveToStorage(),this.renderLog()}clearLog(){this.phrases=[],this.saveToStorage(),this.renderLog()}copyToClipboard(){const t=this.phrases.map(e=>e.text).join(`
`);navigator.clipboard.writeText(t)}exportAsTxt(){const t=this.phrases.map(e=>e.text).join(`
`);this.downloadFile(t,"beale-log.txt","text/plain")}exportAsJson(){const t=JSON.stringify(this.phrases,null,2);this.downloadFile(t,"beale-log.json","application/json")}downloadFile(t,e,i){const s=new Blob([t],{type:i}),a=URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}saveToStorage(){localStorage.setItem("bealePhrases",JSON.stringify(this.phrases))}renderLog(){this.logList.innerHTML="",this.phrases.forEach(t=>{const e=document.createElement("li");e.textContent=t.text,this.logList.appendChild(e)})}}const j=[{id:"sample1",title:"Humpback Whale Song - Pacific Ocean",description:"A classic humpback whale song recorded in the Pacific Ocean",filename:"humpback_whale_sound_pdb.mp3",duration:"4.07",source:"TBD"},{id:"sample2",title:"Humpback Whale Song - Hawaii",description:"A humpback whale song recorded by the Jupiter team in Hawaii",filename:"humpback_hawaii_jupiter_1.mp3",duration:"2.47",source:"TBD"},{id:"sample3",title:"Humpback Whale Song - NOAA",description:"A humpback whale song, NOAA Sounds of the Sea Project",filename:"noaa_humpback_whale_1.mp3",duration:".47",source:"TBD"}],G={audioFiles:j};class W{constructor(t,e){this.audioFiles=G.audioFiles,this.select=document.getElementById("audioLibrary"),this.audioElement=document.getElementById("audio"),this.descriptionDiv=document.getElementById("audioDescription"),this.analyzeBtn=document.getElementById("analyzeLibraryAudio"),this.onAnalyzeLibraryAudio=t,this.onAudioLoaded=e,this.selectedFile=null,this.initializeLibrary()}initializeLibrary(){this.audioFiles.forEach(t=>{const e=document.createElement("option");e.value=t.filename,e.textContent=`${t.title} (${t.duration})`,this.select.appendChild(e)}),this.select.addEventListener("change",t=>{const e=this.audioFiles.find(i=>i.filename===t.target.value);e?(this.selectedFile=e,this.loadAudioFile(e.filename),this.descriptionDiv.innerHTML=`<strong>Description:</strong> ${e.description}<br><strong>Source:</strong> ${e.source}`,this.analyzeBtn.disabled=!1,this.analyzeBtn.classList.add("show"),this.onAudioLoaded&&this.onAudioLoaded()):(this.selectedFile=null,this.descriptionDiv.innerHTML="",this.analyzeBtn.disabled=!0,this.analyzeBtn.classList.remove("show"),this.onAudioLoaded&&this.onAudioLoaded(!1))}),this.analyzeBtn.addEventListener("click",()=>{this.selectedFile&&this.onAnalyzeLibraryAudio&&this.onAnalyzeLibraryAudio(this.selectedFile)})}loadAudioFile(t){const e=`audio/${t}`;this.audioElement.src=e,this.audioElement.load()}getCurrentAudio(){return this.audioElement}}class J{constructor(){console.log("Initializing BEALELite..."),this.audioFile=document.getElementById("audioFile"),this.audio=document.getElementById("audio"),this.canvas=document.getElementById("visualizer"),this.spectrogramCanvas=document.getElementById("spectrogram"),this.phraseOutput=document.getElementById("phrase"),this.logList=document.getElementById("logList"),this.emotionalistMode=document.getElementById("emotionalistMode"),this.analystMode=document.getElementById("analystMode"),this.copyLog=document.getElementById("copyLog"),this.exportTxt=document.getElementById("exportTxt"),this.exportJson=document.getElementById("exportJson"),this.clearLog=document.getElementById("clearLog"),this.customPlayBtn=document.getElementById("customPlay"),this.playIcon=document.getElementById("playIcon"),this.pauseIcon=document.getElementById("pauseIcon"),this.audioStatus=document.getElementById("audioStatus"),this.audioProgressBar=document.getElementById("audioProgressBar"),this.audioProgress=document.getElementById("audioProgress"),this.audioCurrentTime=document.getElementById("audioCurrentTime"),this.audioDuration=document.getElementById("audioDuration"),this.customAudioInterface=document.querySelector(".custom-audio-interface"),console.log("DOM elements initialized:",{audioFile:!!this.audioFile,audio:!!this.audio,canvas:!!this.canvas,spectrogramCanvas:!!this.spectrogramCanvas}),this.audioProcessor=new P(this.canvas,this.spectrogramCanvas),this.phraseGenerator=new H,this.logManager=new N(this.logList),this.currentMode="emotionalist",this.lastLoggedTime=0,this.logInterval=4,this.isAudioInitialized=!1,this.analyzedUnits=[],this.bindEvents()}bindEvents(){console.log("Binding events..."),this.audioFile.addEventListener("change",async t=>{console.log("File selected, handling file select..."),await this.handleFileSelect(t)}),this.audio.addEventListener("play",()=>{console.log("Audio playback started..."),this.isAudioInitialized||(console.log("Initializing audio processor..."),this.audioProcessor.initialize(this.audio),this.isAudioInitialized=!0),this.audioProcessor.start(),this.lastLoggedTime=0,this.playIcon.style.display="none",this.pauseIcon.style.display=""}),this.audio.addEventListener("pause",()=>{console.log("Audio paused, stopping audio processor..."),this.audioProcessor.stop(),this.playIcon.style.display="",this.pauseIcon.style.display="none"}),this.emotionalistMode.addEventListener("click",()=>this.setMode("emotionalist")),this.analystMode.addEventListener("click",()=>this.setMode("analyst")),this.copyLog.addEventListener("click",()=>this.logManager.copyToClipboard()),this.exportTxt.addEventListener("click",()=>this.logManager.exportAsTxt()),this.exportJson.addEventListener("click",()=>this.logManager.exportAsJson()),this.clearLog.addEventListener("click",()=>this.logManager.clearLog()),this.customPlayBtn.addEventListener("click",()=>{this.audio.src&&!this.customPlayBtn.disabled&&(this.audio.paused?this.audio.play():this.audio.pause())}),requestAnimationFrame(()=>this.update()),this.audio.addEventListener("timeupdate",()=>{this.updateAudioProgress()}),this.audio.addEventListener("loadedmetadata",()=>{this.updateAudioProgress()}),this.audioProgressBar.addEventListener("click",t=>{const e=this.audioProgressBar.getBoundingClientRect(),s=(t.clientX-e.left)/e.width;isNaN(this.audio.duration)||(this.audio.currentTime=s*this.audio.duration)})}async handleFileSelect(t){console.log("Handling file select...");const e=t.target.files[0];if(!e){console.log("No file selected"),this.setAudioLoadedState(!1);return}console.log("File selected:",e.name);try{this.phraseOutput.textContent="Analyzing audio file",this.phraseOutput.classList.add("loading-text");const i=await this.audioProcessor.analyzeAudioFile(e);this.analyzedUnits=i.units,this.phraseOutput.classList.remove("loading-text"),console.log("Analysis results:",{numberOfUnits:this.analyzedUnits.length,duration:i.duration,sampleRate:i.sampleRate}),this.logManager.addPhrase(`Found ${this.analyzedUnits.length} distinct units in the audio file (${i.duration.toFixed(2)} seconds):`),this.analyzedUnits.forEach((n,o)=>{const d=n.startTime.toFixed(2),h=n.endTime.toFixed(2),g=n.duration.toFixed(2),l=n.dominantFrequency.toFixed(0),m=n.averageIntensity.toFixed(1),u=[`Unit ${o+1}:`,`  Time: ${d}s to ${h}s (duration: ${g}s)`,`  Dominant Frequency: ${l} Hz`,`  Average Intensity: ${m} dB`,`  Peak Frequencies Range: ${Math.min(...n.peakFrequencies).toFixed(0)}Hz - ${Math.max(...n.peakFrequencies).toFixed(0)}Hz`].join(`
`);this.logManager.addPhrase(u)});const s=URL.createObjectURL(e);this.audio.src=s,this.isAudioInitialized=!1,this.phraseOutput.textContent="Analysis complete - Ready to play";const a=document.getElementById("unit-view");if(a&&a.remove(),i.units&&i.units.length>0){const n=this.createUnitView(i.units);document.querySelector(".container").appendChild(n)}this.setAudioLoadedState(!0)}catch(i){console.error("Error analyzing file:",i),this.phraseOutput.textContent="Error analyzing audio file"}}setMode(t){this.currentMode=t,this.emotionalistMode.classList.toggle("active",t==="emotionalist"),this.analystMode.classList.toggle("active",t==="analyst")}update(){if(requestAnimationFrame(()=>this.update()),!this.audioProcessor.isPlaying)return;const t=this.audioProcessor.getAudioData();if(!t)return;const e=this.audio.currentTime;if(e-this.lastLoggedTime>=this.logInterval){const i=this.phraseGenerator.generatePhrase(t.peakFrequency,t.averageVolume,e,this.currentMode);this.phraseOutput.textContent=i,this.logManager.addPhrase(i),this.lastLoggedTime=e}}createUnitView(t){const e=document.createElement("div");e.id="unit-view",e.style.cssText=`
      margin-top: 20px;
      padding: 20px;
      background: var(--secondary-bg);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;const i=document.createElement("h2");i.textContent="Detected Units",i.style.marginBottom="15px",e.appendChild(i);const s=document.createElement("div");return s.style.cssText=`
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    `,t.forEach((a,n)=>{const o=document.createElement("div");o.className="unit-card",o.style.cssText=`
        padding: 15px;
        background: var(--primary-bg);
        border-radius: 6px;
        border: 1px solid var(--border-color);
      `;const d=document.createElement("h3");d.textContent=`Unit ${n+1}`,d.style.marginBottom="10px";const h=document.createElement("canvas");h.width=280,h.height=80,h.style.cssText=`
        width: 100%;
        height: 80px;
        background: #000;
        border-radius: 4px;
        margin-bottom: 10px;
      `,this.drawUnitSpectrogram(h,a);const g=document.createElement("div");g.innerHTML=`
        <div style="margin-bottom: 8px;">
          <strong>Time Range:</strong> ${a.startTime.toFixed(2)}s - ${a.endTime.toFixed(2)}s
        </div>
        <div style="margin-bottom: 8px;">
          <strong>Duration:</strong> ${a.duration.toFixed(2)}s
        </div>
        <div style="margin-bottom: 8px;">
          <strong>Dominant Frequency:</strong> ${a.dominantFrequency.toFixed(1)} Hz
        </div>
        <div style="margin-bottom: 8px;">
          <strong>Average Intensity:</strong> ${a.averageIntensity.toFixed(1)} dB
        </div>
      `;const l=document.createElement("button");l.textContent="Play Unit",l.style.cssText=`
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
        width: 100%;
        position: relative;
        overflow: hidden;
      `;const m=document.createElement("div");m.style.cssText=`
        position: absolute;
        left: 0;
        bottom: 0;
        height: 2px;
        width: 0%;
        background: rgba(255, 255, 255, 0.5);
        transition: width 0.1s linear;
      `,l.appendChild(m);let u=!1;l.onclick=()=>{const y=document.querySelector("audio");if(y)if(u)y.pause(),l.textContent="Play Unit",m.style.width="0%",u=!1;else{y.currentTime=a.startTime,y.play(),l.textContent="Stop",u=!0;const I=()=>{if(!u)return;const S=(y.currentTime-a.startTime)/a.duration*100;m.style.width=`${Math.min(100,S)}%`,y.currentTime<a.startTime+a.duration&&u?requestAnimationFrame(I):(u=!1,l.textContent="Play Unit",m.style.width="0%")};I(),setTimeout(()=>{u&&(y.pause(),l.textContent="Play Unit",m.style.width="0%",u=!1)},a.duration*1e3)}},o.appendChild(d),o.appendChild(h),o.appendChild(g),o.appendChild(l),s.appendChild(o)}),e.appendChild(s),e}drawUnitSpectrogram(t,e){const i=t.getContext("2d"),s=e.spectrogramSlices;if(!s||s.length===0)return;const a=t.width/s.length,n=t.height;i.clearRect(0,0,t.width,t.height);let o=1/0,d=-1/0;s.forEach(h=>{h.forEach(g=>{o=Math.min(o,g),d=Math.max(d,g)})}),isFinite(o)||(o=-90),isFinite(d)||(d=-30),s.forEach((h,g)=>{const l=g*a;h.forEach((m,u)=>{const y=(m-o)/(d-o),I=n*(u/h.length),S=n/h.length,C=Math.floor(y*255),v=this.getSpectrogramColor(C);i.fillStyle=v,i.fillRect(l,n-I,a,-S)})})}getSpectrogramColor(t){return t<64?`rgb(0, 0, ${Math.floor(t*4)})`:t<128?`rgb(0, ${Math.floor((t-64)*4)}, 255)`:t<192?`rgb(${Math.floor((t-128)*4)}, 255, ${Math.floor(255-(t-128)*4)})`:`rgb(255, ${Math.floor(255-(t-192)*4)}, 0)`}setAudioLoadedState(t){t?(this.audio.pause(),this.audio.currentTime=0,this.customPlayBtn.disabled=!1,this.playIcon.style.display="",this.pauseIcon.style.display="none",this.audioStatus.textContent="",this.customAudioInterface.classList.add("audio-loaded")):(this.audio.pause(),this.audio.currentTime=0,this.customPlayBtn.disabled=!0,this.playIcon.style.display="",this.pauseIcon.style.display="none",this.audioStatus.textContent="No audio loaded. Please select or upload a track.",this.customAudioInterface.classList.remove("audio-loaded"))}async analyzeLibraryAudio(t){try{this.phraseOutput.textContent="Analyzing audio file",this.phraseOutput.classList.add("loading-text");const i=await(await fetch(`audio/${t.filename}`)).blob(),s=new File([i],t.filename,{type:i.type});await this.handleFileSelect({target:{files:[s]}})}catch(e){this.phraseOutput.textContent="Error analyzing audio file",console.error("Error analyzing library audio:",e)}}updateAudioProgress(){const t=this.audio.duration||0,e=this.audio.currentTime||0,i=t?e/t*100:0;this.audioProgress.style.width=i+"%",this.audioCurrentTime.textContent=this.formatTime(e),this.audioDuration.textContent=this.formatTime(t)}formatTime(t){if(isNaN(t))return"0:00";const e=Math.floor(t/60),i=Math.floor(t%60);return`${e}:${i.toString().padStart(2,"0")}`}}document.addEventListener("DOMContentLoaded",()=>{let T;new W(t=>{T&&T.analyzeLibraryAudio(t)},(t=!0)=>{T&&T.setAudioLoadedState(t)}),T=new J});
